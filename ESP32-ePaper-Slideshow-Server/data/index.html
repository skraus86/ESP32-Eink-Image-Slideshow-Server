<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ESP32 E-Ink Slideshow</title>
<style>
  body { font-family: Arial, sans-serif; margin: 1em; }
  #fileList div { margin-bottom: 1em; }
  canvas { border: 1px solid #ccc; margin-right: 1em; vertical-align: middle; }
  button { margin-left: 1em; }
</style>
</head>
<body>
<h1>ESP32 E-Ink Slideshow</h1>

<input type="file" id="fileInput" accept="image/*" />
<label><input type="checkbox" id="dither"> Apply Floyd-Steinberg Dithering</label>
<button onclick="upload()">Upload</button>

<h2>Uploaded Images</h2>
<div id="fileList"></div>

<script>
const fileInput = document.getElementById("fileInput");
const fileListDiv = document.getElementById("fileList");
const ditherCheckbox = document.getElementById("dither");

async function refreshFileList() {
  const res = await fetch("/list");
  const data = await res.json();
  fileListDiv.innerHTML = "";

  for (const filename of data.files) {
    const div = document.createElement("div");

    // Create canvas for preview
    const canvas = document.createElement("canvas");
    canvas.width = 200;
    canvas.height = 120;

    // Draw preview
    drawBinImage(filename, canvas);

    // Filename label
    const label = document.createElement("span");
    label.textContent = filename;

    // Delete button
    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.onclick = async () => {
      if (confirm(`Delete ${filename}?`)) {
        await fetch(`/delete?name=${encodeURIComponent(filename)}`);
        refreshFileList();
      }
    };

    div.appendChild(canvas);
    div.appendChild(label);
    div.appendChild(delBtn);

    fileListDiv.appendChild(div);
  }
}

async function drawBinImage(filename, canvas) {
  try {
    const res = await fetch(`/image?name=${encodeURIComponent(filename)}`);
    if (!res.ok) {
      console.error("Failed to fetch image", filename);
      return;
    }
    const buffer = await res.arrayBuffer();
    const bytes = new Uint8Array(buffer);

    const ctx = canvas.getContext("2d");
    const imgData = ctx.createImageData(canvas.width, canvas.height);

    // Original image is 800x480, scale down 4x
    const scaleX = 800 / canvas.width;
    const scaleY = 480 / canvas.height;

    for (let y = 0; y < canvas.height; y++) {
      for (let x = 0; x < canvas.width; x++) {
        const origX = Math.floor(x * scaleX);
        const origY = Math.floor(y * scaleY);
        const byteIndex = Math.floor((origY * 800 + origX) / 8);
        const bitIndex = 7 - (origX % 8);
        const bit = (bytes[byteIndex] >> bitIndex) & 1;
        const color = bit ? 0 : 255;
        const idx = (y * canvas.width + x) * 4;
        imgData.data[idx] = color;
        imgData.data[idx + 1] = color;
        imgData.data[idx + 2] = color;
        imgData.data[idx + 3] = 255;
      }
    }
    ctx.putImageData(imgData, 0, 0);
  } catch (e) {
    console.error("Error drawing image preview:", e);
  }
}

function floydSteinbergDither(imageData) {
  const w = imageData.width;
  const h = imageData.height;
  const data = imageData.data;

  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      const idx = (y * w + x) * 4;
      const oldPixel = data[idx];
      const newPixel = oldPixel < 128 ? 0 : 255;
      const err = oldPixel - newPixel;

      data[idx] = data[idx + 1] = data[idx + 2] = newPixel;

      if (x + 1 < w) {
        let i = idx + 4;
        data[i] = clamp(data[i] + err * 7 / 16);
        data[i + 1] = clamp(data[i + 1] + err * 7 / 16);
        data[i + 2] = clamp(data[i + 2] + err * 7 / 16);
      }
      if (y + 1 < h) {
        if (x > 0) {
          let i = idx + (w - 1) * 4;
          data[i] = clamp(data[i] + err * 3 / 16);
          data[i + 1] = clamp(data[i + 1] + err * 3 / 16);
          data[i + 2] = clamp(data[i + 2] + err * 3 / 16);
        }
        let i = idx + w * 4;
        data[i] = clamp(data[i] + err * 5 / 16);
        data[i + 1] = clamp(data[i + 1] + err * 5 / 16);
        data[i + 2] = clamp(data[i + 2] + err * 5 / 16);
        if (x + 1 < w) {
          let i = idx + (w + 1) * 4;
          data[i] = clamp(data[i] + err * 1 / 16);
          data[i + 1] = clamp(data[i + 1] + err * 1 / 16);
          data[i + 2] = clamp(data[i + 2] + err * 1 / 16);
        }
      }
    }
  }
}

function clamp(value) {
  return Math.min(255, Math.max(0, value));
}

async function convertImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = 800;
        canvas.height = 480;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, 800, 480);

        if (ditherCheckbox.checked) {
          const imgData = ctx.getImageData(0, 0, 800, 480);
          floydSteinbergDither(imgData);
          ctx.putImageData(imgData, 0, 0);
        } else {
          const imgData = ctx.getImageData(0, 0, 800, 480);
          for (let i = 0; i < imgData.data.length; i += 4) {
            const avg = (imgData.data[i] + imgData.data[i+1] + imgData.data[i+2]) / 3;
            const bw = avg < 128 ? 0 : 255;
            imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = bw;
          }
          ctx.putImageData(imgData, 0, 0);
        }

        const imgData = ctx.getImageData(0, 0, 800, 480);
        const buf = new Uint8Array(800 * 480 / 8);
        for (let y = 0; y < 480; y++) {
          for (let x = 0; x < 800; x++) {
            const idx = (y * 800 + x) * 4;
            const bitIndex = 7 - (x % 8);
            const byteIndex = (y * 800 + x) >> 3;
            const pixel = imgData.data[idx];
            if (pixel === 0) {
              buf[byteIndex] |= (1 << bitIndex);
            }
          }
        }
        resolve(buf);
      };
      img.onerror = () => reject("Image load error");
      img.src = event.target.result;
    };
    reader.onerror = () => reject("File read error");
    reader.readAsDataURL(file);
  });
}

async function upload() {
  if (!fileInput.files.length) {
    alert("Please select an image file");
    return;
  }
  const file = fileInput.files[0];
  const filename = file.name.replace(/\.[^/.]+$/, "") + ".bin";

  try {
    const binData = await convertImage(file);
    const blob = new Blob([binData], { type: "application/octet-stream" });
    const formData = new FormData();
    formData.append("upload", blob, filename);

    const res = await fetch("/upload", {
      method: "POST",
      body: formData
    });
    if (res.ok) {
      alert("Upload successful");
      refreshFileList();
    } else {
      alert("Upload failed");
    }
  } catch (e) {
    alert("Error: " + e);
  }
}

refreshFileList();
</script>
</body>
</html>
